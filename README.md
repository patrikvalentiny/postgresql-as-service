# PostgreSQL as a Service

## Overview

This project investigates how PostgreSQL, with its rich ecosystem of extensions and features, can replace many specialized backend tools and services. Inspired by [this video](https://www.youtube.com/watch?v=3JW732GrMdg), we explore practical use cases where PostgreSQL can serve as more than just a relational database.

## *Possible* Use Cases Explored

- **Handling Unstructured Data:**  
  Use JSONB columns to store and query dynamic, object-like data, providing NoSQL-like flexibility within PostgreSQL.

- **Full-Text Search:**  
  Leverage built-in support for full-text search using `tsvector` and GIN indexes, enabling ranking and efficient querying—potentially replacing services like Algolia or Elasticsearch.

- **GraphQL API:**  
  Expose your database as a GraphQL API using the `pg_graphql` extension, allowing direct, flexible queries from any client without extra servers.

- **Real-Time Applications / Sync Layer:**  
  Integrate with tools like ElectricSQL to keep frontend data in sync with the database, reducing the need for custom websocket or polling logic.

- **Authentication:**  
  Implement authentication using `pgcrypto` (for password hashing and salts) and `pgjwt` (for JWT session tokens). Combine with Row Level Security (RLS) to enforce per-user data access policies.

- **RESTful API:**  
  Instantly create a RESTful API with PostgREST, exposing your database over HTTP with JSON responses, filtering, pagination, and authentication.

## Methodology

- For each use case, I will implement a sample solution using the relevant PostgreSQL feature or extension.
- Compare the PostgreSQL-based approach to traditional specialized tool.

## Caution

> "The road to hell is paved with good intentions"
>
> Just because you can do something in PostgreSQL doesn't mean you should.  

## Analysis & Results

### Handling Unstructured Data

### pgcrypto

The pgcrypto module provides cryptographic functions for PostgreSQL.
Examples in the `src/sql/extensions/pgcrypto.sql` show how it can be setup and basic usage.

#### Setup

This module is considered “trusted”, that is, it can be installed by non-superusers who have CREATE privilege on the current database.

```sql
CREATE EXTENSION IF NOT EXISTS pgcrypto;
```

#### Password Hashing

The `crypt(password text, salt text)` method allows to securely store passwords with a salt in order to prevent duplicates and improve security
Salt generation is handled via `gen_salt(type text [, iter_count integer ])`. This method allows to use different algorithms depending on the required security / performance

#### Password verification

`crypt(plaintext password, v_hashed_password)` will return a hash with the same salt as the hashed password.

To be able to check the password easily we can create a function that can be reused

```sql
CREATE OR REPLACE FUNCTION verify_password(
    user_identifier TEXT,
    plain_password TEXT
) RETURNS BOOLEAN 
LANGUAGE plpgsql
AS 
$$
DECLARE
    hashed_password TEXT;
BEGIN
    SELECT password INTO hashed_password
    FROM test_table
    WHERE username = user_identifier OR email = user_identifier OR user_id = uuid(user_identifier);

    IF hashed_password IS NULL THEN
        RETURN FALSE;
    END IF;

    RETURN crypt(plain_password, hashed_password) = hashed_password;
END;
$$;
```

### pgjwt

The pgjwt extension provides functions to create and verify JSON Web Tokens (JWT) directly in PostgreSQL.

#### Setup

Install the extension (requires superuser):

```sql
CREATE EXTENSION IF NOT EXISTS pgjwt;
```

#### Creating a JWT

Use the `sign` function to generate a JWT from a JSON payload and secret key:

```sql
SELECT sign(
  '{"sub": "user123", "role": "admin"}',
  'your_secret_key'
) AS jwt_token;
```

You can also include standard claims like `iat` (issued at) and `exp` (expiration):

```sql
SELECT sign(
  json_build_object(
    'sub', 'user123',
    'role', 'admin',
    'iat', EXTRACT(EPOCH FROM now())::integer,
    'exp', EXTRACT(EPOCH FROM now() + INTERVAL '5 minutes')::integer
  ),
  'your_secret_key'
) AS jwt_token;
```

#### Verifying a JWT

Use the `verify` function to check and decode a JWT:

```sql
SELECT verify(
  'jwt_token_here',
  'your_secret_key'
) AS payload;
```

### PostgREST

PostgREST is not a PostgreSQL extension, but a standalone middleware server that automatically generates a RESTful API from your database schema.

#### Quickstart Example

1. **Set up schema, roles, and a sample table:**

```sql
-- Remove existing schema and create a new one
DROP SCHEMA IF EXISTS api CASCADE;
CREATE SCHEMA api;

-- Create roles for anonymous and authenticated access
DROP ROLE IF EXISTS web_anon;
CREATE ROLE web_anon nologin;
GRANT USAGE ON SCHEMA api TO web_anon;

CREATE TABLE api.todos (
  id INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  done BOOLEAN NOT NULL DEFAULT FALSE,
  task TEXT NOT NULL,
  due TIMESTAMPTZ
);

INSERT INTO api.todos (task) VALUES
  ('finish tutorial 0'), ('pat self on back');

GRANT SELECT ON api.todos TO web_anon;

DROP ROLE IF EXISTS authenticator;
CREATE ROLE authenticator NOINHERIT LOGIN PASSWORD 'mysecretpassword';
GRANT web_anon TO authenticator;
```

2. **Run PostgREST using Docker Compose:**

```yaml
postgrest:
  image: postgrest/postgrest
  ports:
    - "3000:3000"
  environment:
    PGRST_DB_URI: postgres://authenticator:mysecretpassword@db:5432/postgres
    PGRST_DB_ANON_ROLE: web_anon
    PGRST_DB_SCHEMA: api
    PGRST_OPENAPI_SERVER_PROXY_URI: http://127.0.0.1:3000
  depends_on:
    - db
```

With this setup, PostgREST will expose your `api.todos` table as a RESTful endpoint, allowing HTTP clients to interact with your data using standard REST operations.

You can test the REST endpoint with `curl`:

```sh
curl http://localhost:3000/todos
```

This will return the list of todos in JSON format.

## Conclusion

TBD

## References

- [Replace Your Backend with Postgres (YouTube)](https://www.youtube.com/watch?v=3JW732GrMdg)
- [PostgreSQL Official Documentation](https://www.postgresql.org/docs/)
- [pg_cron](https://github.com/citusdata/pg_cron)
- [pg_graphql](https://github.com/supabase/pg_graphql)
- [ElectricSQL](https://electric-sql.com/)
- [pgcrypto](https://www.postgresql.org/docs/current/pgcrypto.html)
- [pgjwt](https://github.com/michelp/pgjwt)
- [pg_mooncake](https://github.com/cwida/pg_mooncake)
- [PostgREST](https://postgrest.org/)

## Appendix
